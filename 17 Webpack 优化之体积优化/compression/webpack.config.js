const TerserPlugin = require("terser-webpack-plugin")
const MiniCssExtractPlugin = require("mini-css-extract-plugin")
const OptimizeCssAssetsPlugin = require("optimize-css-assets-webpack-plugin")

module.exports = {
  optimization: {
    // å¼€å¯Scope Hoisting/ä½œç”¨åŸŸæå‡, æŠŠä¸åŒæ¨¡å—æ‰“åŒ…æˆä¸€ä¸ªå‡½æ•°ï¼ˆå¯ä»¥è®©webpackæ‰“åŒ…å‡ºæ¥çš„ä»£ç æ–‡ä»¶ä½“ç§¯æ›´å°, è¿è¡Œæ›´å¿«ï¼‰
    concatenateModules: true,
    minimizer: [
      new TerserPlugin({
        // ä½¿ç”¨ cacheï¼ŒåŠ å¿«äºŒæ¬¡æ„å»ºé€Ÿåº¦
        cache: true,
        parallel: true, // å¤šçº¿ç¨‹
        terserOptions: {
          comments: false,
          // åˆ é™¤å†—ä½™ä»£ç ä»¥è¿›ä¸€æ­¥å‹ç¼©ä½“ç§¯
          compress: {
            // åˆ é™¤æ— ç”¨çš„ä»£ç 
            unused: true,
            // åˆ æ‰ debugger
            drop_debugger: true, // eslint-disable-line
            // ç§»é™¤ console
            drop_console: true, // eslint-disable-line
            // ç§»é™¤æ— ç”¨çš„ä»£ç 
            dead_code: true, // eslint-disable-line
          },
        },
      }),
    ],
  },
  module: {
    rules: [
      {
        test: /\.css$/,
        use: [
          {
            loader: MiniCssExtractPlugin.loader,
            options: {
              publicPath: "../",
              hmr: process.env.NODE_ENV === "development",
            },
          },
          "css-loader",
        ],
      },
    ],
  },
  plugins: [
    new MiniCssExtractPlugin({
      filename: "[name].css",
      chunkFilename: "[name].[contenthash:8].css",
    }),
    // optimize-css-assets-webpack-plugin æ’ä»¶é»˜è®¤çš„ cssnano é…ç½®å·²ç»åšçš„å¾ˆå‹å¥½äº†ï¼Œä¸éœ€è¦é¢å¤–çš„é…ç½®å°±å¯ä»¥è¾¾åˆ°æœ€ä½³æ•ˆæœã€‚
    new OptimizeCssAssetsPlugin({
      assetNameRegExp: /\.optimize\.css$/g,
      cssProcessor: require("cssnano"), // è¿™é‡ŒæŒ‡å®šäº†å¼•æ“ï¼Œä¸æŒ‡å®šé»˜è®¤ä¹Ÿæ˜¯ cssnano
      cssProcessorPluginOptions: {
        preset: ["default", { discardComments: { removeAll: true } }],
      },
      canPrint: true,
    }),
  ],
}

// Tips:
// è™½ç„¶ç”Ÿäº§æ¨¡å¼ä¸‹webpackè‡ªå¸¦å‹ç¼©åŠŸèƒ½, ä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¯ä»¥è‡ªå®šä¹‰å‹ç¼©æ’ä»¶å’Œå¯¹åº”é…ç½®æ¥è¿›è¡Œæ›´ä¸ºåˆç†çš„æ‰“åŒ…ä½“ç§¯ä¼˜åŒ–æ“ä½œ

// module oneï¼ˆJSï¼‰
// å…¶ä»–ä»£ç çº§åˆ«ä¼˜åŒ–æŠ€å·§:
// åˆç†åˆ’åˆ†ä»£ç èŒè´£, å¹¶ä½¿ç”¨å¯¹åº”çš„æŒ‰éœ€åŠ è½½
// å–„ç”¨webpack-bundle-analyzeræ’ä»¶, å¸®åŠ©åˆ†æwebpackæ‰“åŒ…åçš„æ¨¡å—ä¾èµ–å…³ç³»å’Œå¯è§†åŒ–æŸ¥çœ‹å„æ¨¡å—çš„ä½“ç§¯å¤§å°, é’ˆå¯¹æ€§å‡å°ä½“ç§¯å¦‚æ¢æˆè¾ƒå°çš„æ¨¡å—ç­‰ï¼ˆmomentåº“è½¬date-fnsåº“ï¼‰;ä½¿ç”¨ lodashã€momentjs è¿™ç±»åº“ï¼Œä¸è¦ä¸€è‚¡è„‘å¼•å…¥ï¼Œè¦æŒ‰éœ€å¼•å…¥
// è®¾ç½®åˆç†çš„SplitChunksåˆ†ç»„

// æ›´ç»†åŒ–ä¸€ç‚¹:
// åˆç†ä½¿ç”¨hashå ä½ç¬¦ï¼Œé˜²æ­¢å› é¢å¤–çš„æ–‡ä»¶åå˜åŒ–è€Œå¯¼è‡´çš„HTTPç¼“å­˜è¿‡æœŸ
// åˆç†ä½¿ç”¨ polyfillï¼Œé˜²æ­¢å¤šä½™çš„ä»£ç ï¼›
// ä½¿ç”¨ ES6 è¯­æ³•ï¼Œå°½é‡ä¸ä½¿ç”¨å…·æœ‰å‰¯ä½œç”¨çš„ä»£ç ï¼Œä»¥åŠ å¼º Tree-Shaking çš„æ•ˆæœï¼›
// ä½¿ç”¨webpackçš„Scope Hoisting/ä½œç”¨åŸŸæå‡åŠŸèƒ½

// å¯¹ç»„ä»¶åº“çš„é’ˆå¯¹æ€§ä¼˜åŒ–ï¼š
// å¯¹äºUIç»„ä»¶åº“å¯ä»¥è¿›è¡Œé’ˆå¯¹æ€§ä¼˜åŒ–, æ¯”å¦‚AntDesignã€ElementUIç­‰å¯ä»¥ä½¿ç”¨babel-plugin-importè¿™ç±»æ’ä»¶/å·¥å…·è¿›è¡Œä¼˜åŒ–

// module twoï¼ˆJSï¼‰
// å…¶å® webpack 4 ä¸­ï¼Œåœ¨ production æ¨¡å¼ä¸‹å·²ç»æ ¹æ®å¤§å¤šæ•°é¡¹ç›®çš„ä¼˜åŒ–ç»éªŒåšäº†é€šç”¨çš„é…ç½®ï¼Œç±»ä¼¼ Tree-Shakingã€Scope Hoisting éƒ½æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œè€Œä¸”æœ€æ–°ç‰ˆæœ¬çš„ Webpack ä½¿ç”¨çš„å‹ç¼©å·¥å…·å°±æ˜¯ terser-webpack-pluginã€‚

// module threeï¼ˆCSSï¼‰
// webpackæœ¬èº«æ˜¯jsçš„æ‰“åŒ…å™¨ï¼Œåœ¨cssæ–¹é¢åˆ©ç”¨å¼ºå¤§çš„ç¤¾åŒºæ’ä»¶ï¼Œä¹Ÿå¯ä»¥å®ç°CSSä¼˜åŒ–ï¼ˆåŒ…æ‹¬ä»£ç å‹ç¼©æ··æ·†ç­‰ï¼‰ ğŸ‘‰

// ç”Ÿäº§ç¯å¢ƒCSS å¯¼å‡ºå’Œå‹ç¼©ä½¿ç”¨ mini-css-extract-pluginï¼ˆä¸€èˆ¬æ€§å‹ç¼©ï¼‰
// é¦–å…ˆæˆ‘ä»¬çš„ CSS æ–‡ä»¶åº”è¯¥æ˜¯å¯¼å‡ºåˆ°å•ç‹¬çš„ CSS æ–‡ä»¶ä¸­ï¼Œè€Œä¸è¦ç›´æ¥æ‰“åŒ…åˆ° JavaScript æ–‡ä»¶ä¸­ï¼Œç„¶åé€šè¿‡style-loaderçš„ addStylesæ–¹æ³•æ·»åŠ è¿›å»ï¼Œå¯¼å‡º CSS æ–‡ä»¶/ç”Ÿäº§ç¯å¢ƒå°±éœ€è¦ä½¿ç”¨mini-css-extract-pluginè¿™ä¸ªæ’ä»¶ã€‚

// å¦å¤–è¿˜å¯ä»¥åœ¨postcss-loaderä¸­é…ç½®é…ç½®cssnanoæ’ä»¶è¿›è¡Œæ›´åŠ å½»åº•çš„å‹ç¼©, å¦‚ä¸‹
// cssnanoæ˜¯åŸºäº postcss çš„ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„æ’ä»¶åŒ…ï¼Œå®ƒé›†æˆäº† 30 å¤šä¸ªæ’ä»¶ï¼Œåªéœ€è¦æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œå°±å¯ä»¥å¯¹æˆ‘ä»¬çš„ CSS åšå¤šæ–¹é¢ä¸åŒç±»å‹çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚ï¼š

// åˆ é™¤ç©ºæ ¼å’Œæœ€åä¸€ä¸ªåˆ†å·ï¼›
// åˆ é™¤æ³¨é‡Šï¼›
// ä¼˜åŒ–å­—ä½“æƒé‡ï¼›
// ä¸¢å¼ƒé‡å¤çš„æ ·å¼è§„åˆ™ï¼›
// å‹ç¼©é€‰æ‹©å™¨ï¼›
// å‡å°‘æ‰‹å†™å±æ€§ï¼›
// åˆå¹¶è§„åˆ™ï¼›

// cssnano å¾ˆæ™ºèƒ½ï¼Œå®ƒèƒ½å¤Ÿå°† CSS è§„åˆ™ç›¸åŒçš„é€‰æ‹©å™¨è¿›è¡Œåˆå¹¶ï¼Œå¹¶ä¸”è¿˜èƒ½å¤Ÿå°†colorè¿›è¡Œä»»æ„çš„åˆ‡æ¢ï¼Œè¿™æ ·çš„æ„ä¹‰æ˜¯ä¸ºäº†ç¼©çŸ­å®é™…çš„å­—ç¬¦ä¸²é•¿åº¦ã€‚
// åœ¨webpackä¸­, css-loaderå·²ç»é›†æˆäº†cssnano, è€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨optimize-css-assets-webpack-pluginæ’ä»¶æ˜ç¡®å…·ä½“çš„cssnanoçš„è§„åˆ™ä½¿ç”¨, å› ä¸ºæ­¤æ’ä»¶é»˜è®¤ä½¿ç”¨çš„å‹ç¼©å·¥å…·/å¼•æ“å°±æ˜¯cssnano.

// module threeï¼ˆå›¾ç‰‡ï¼‰
// å›¾ç‰‡èµ„æºä¼˜åŒ–
// é€šå¸¸æˆ‘ä»¬çš„ä»£ç ä½“ç§¯ä¼šæ¯”å›¾ç‰‡ä½“ç§¯å°å¾ˆå¤šï¼Œæœ‰çš„æ—¶å€™æ•´ä¸ªé¡µé¢çš„ä»£ç éƒ½ä¸å¦‚ä¸€å¼ å¤´å›¾å¤§ã€‚å¥½åœ¨å›¾ç‰‡èµ„æºä¸ä¼šé˜»å¡æµè§ˆå™¨æ¸²æŸ“ï¼Œä½†æ˜¯ä¸åˆç†çš„å›¾ç‰‡å¤§å°ä¹Ÿä¼šæ¶ˆè€—ä¸€å®šçš„ä»£ç (ä½“ç§¯)ã€‚åœ¨ä¹‹å‰ç« èŠ‚ä¸­ä¹Ÿå·²ç»æåˆ°ä½¿ç”¨ï¼šurl-loaderã€svg-url-loader å’Œ image-webpack-loader æ¥ä¼˜åŒ–å›¾ç‰‡ï¼Œè¿˜ä»‹ç»äº†ä½¿ç”¨é›ªç¢§å›¾æ¥ä¼˜åŒ–å›¾ç‰‡èµ„æºã€‚

// url-loader å¯ä»¥æŒ‰ç…§é…ç½®å°†å°äºä¸€å®šä½“ç§¯çš„é™æ€æ–‡ä»¶å†…è”è¿›æˆ‘ä»¬çš„åº”ç”¨ã€‚å½“æˆ‘ä»¬æŒ‡å®šäº† limit è¿™ä¸ª options é€‰é¡¹ï¼Œå®ƒä¼šå°†æ–‡ä»¶ç¼–ç æˆæ¯”æ— é…ç½®æ›´å°çš„ Base64 çš„æ•°æ® url å¹¶å°†è¯¥ url è¿”å›ï¼Œè¿™æ ·å¯ä»¥å°†å›¾ç‰‡å†…è”è¿› JavaScript ä»£ç ä¸­ï¼Œå¹¶èŠ‚çœä¸€æ¬¡ HTTP è¯·æ±‚ã€‚svg-url-loader çš„å·¥ä½œåŸç†ç±»ä¼¼äº url-loaderï¼Œé™¤äº†å®ƒåˆ©ç”¨ URL encoding è€Œä¸æ˜¯ Base64 å¯¹æ–‡ä»¶ç¼–ç ï¼Œå¯¹äº SVG å›¾ç‰‡æ¥è¯´ï¼Œsvg-url-loader çš„è¿™ç§æ–¹å¼è¿™æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸º SVG æ–‡ä»¶æœ¬è´¨ä¸Šæ˜¯çº¯æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™ç§ URL encoding ç¼–ç è§„æ¨¡æ•ˆåº”æ›´åŠ æ˜æ˜¾ã€‚

// å¦‚æœæˆ‘ä»¬çš„é¡¹ç›®ä¸­å°å›¾ç‰‡ç‰¹åˆ«å¤šï¼Œä¾‹å¦‚æœ‰å¾ˆå¤š icon ç±»çš„å›¾æ ‡ï¼Œè¿™æ—¶å€™åˆ™æ¨èä½¿ç”¨é›ªç¢§å›¾ï¼ˆCSS Spriteï¼‰æ¥åˆå¹¶è¿™äº›å°å›¾åˆ°ä¸€å¼ å¤§å›¾ä¸­ï¼Œç„¶åä½¿ç”¨background-positionæ¥è®¾ç½®å›¾ç‰‡çš„ä½ç½®ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼å¯ä»¥èŠ‚çœå¤šæ¬¡å°å›¾ç‰‡çš„è¯·æ±‚ã€‚

// å¯¹äºå¤§å›¾ç‰‡æ¥è¯´ï¼Œå¯ä»¥ä½¿ç”¨image-webpack-loaderæ¥å‹ç¼©å›¾ç‰‡ï¼Œimage-webpack-loader å®ƒæ”¯æŒ JPGã€PNGã€GIF å’Œ SVG æ ¼å¼çš„å›¾ç‰‡ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ç¢°åˆ°æ‰€æœ‰è¿™äº›ç±»å‹çš„å›¾ç‰‡éƒ½ä¼šä½¿ç”¨å®ƒã€‚

// æ€»ç»“ï¼š

// url-loaderï¼ˆå°å›¾ï¼‰é€šè¿‡å°†ä½äºä¸€å®šå¤§å°çš„å›¾ç‰‡è½¬ä¸ºbase64å†…è”è¿›ä»£ç å‡å°ä»£ç ä½“ç§¯çš„åŒæ—¶, å‡å°‘ä¸€æ¬¡httpè¯·æ±‚ã€‚
// srg-url-loaderï¼ˆå°å›¾ï¼‰é€šè¿‡url-encodingçš„æ–¹å¼å‹ç¼©svgä»£ç æ¥è¾¾æˆå¯è§‚çš„ä»£ç å‹ç¼©è§„æ¨¡æ•ˆåº”ã€‚
// å¤§å›¾åˆ™å¯ä»¥é€šè¿‡image-webpack-loaderè¿›è¡Œé’ˆå¯¹æ€§å‹ç¼©
  